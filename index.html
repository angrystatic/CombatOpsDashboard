<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aliens-Style Combat Tracker (P5.1 - Full Code)</title> <style>
        /* Import Google Font */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            /* --- Theme Configuration --- */
            --monitor-bg: black;
            --primary-color: lime; /* Bright Green */
            --warning-color: #FFD700; /* Gold/Yellow */
            --critical-color: #FF851B; /* Orange */
            --broken-color: #FF4136; /* Red */
            --incapacitated-color: #0074D9; /* Blue for Incapacitated */
            --dead-color: #555555; /* Dark Grey */
            --card-bg: #1a1a1a; /* Dark Background for card */
            --card-border-color: var(--primary-color);
            --text-color: var(--primary-color); /* Primary text color for areas below monitor */
            --overlay-text-color: white; /* Brighter text for overlay */
            --input-bg: #222;
            --input-border: var(--primary-color);
            --grid-color: rgba(0, 255, 0, 0.08); /* Faint green grid */
            --font-family: 'VT323', monospace; /* Retro pixel font */
            --text-shadow: 1px 1px 2px black; /* Shadow for overlay readability */
            /* --- End Theme --- */
        }

        body {
            font-family: var(--font-family); background-color: #0a0a0a; color: var(--text-color);
            margin: 0; padding: 0; font-size: 18px;
        }
        .main-controls { text-align: center; margin: 20px 0; }
        .main-controls button {
             background-color: var(--input-bg); color: var(--text-color); border: 2px solid var(--input-border);
             font-family: inherit; font-size: 1.2em; padding: 8px 15px; border-radius: 4px;
             cursor: pointer; text-transform: uppercase; margin: 0 10px;
        }
         .main-controls button:hover { background-color: var(--primary-color); color: black; border-color: black; }
         .main-controls button:active { transform: translateY(1px); }

        h1 { color: var(--primary-color); text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .dashboard-container { padding: 0 20px 20px 20px; }
        .dashboard { display: flex; flex-wrap: wrap; gap: 25px; justify-content: center; }

        .character-card {
            border: 3px solid var(--card-border-color); background-color: var(--card-bg); padding: 10px;
            border-radius: 4px; width: 320px; /* Back to slightly narrower width */
            box-shadow: inset 0 0 8px 0px rgba(0, 0, 0, 0.5), 3px 3px 8px rgba(0, 0, 0, 0.7);
            display: flex; flex-direction: column; color: var(--text-color); position: relative;
        }

        /* Remove Button Styling */
         .remove-button {
             position: absolute; top: 3px; right: 3px; background-color: #500; color: #fcc; border: 1px solid #a00;
             border-radius: 50%; width: 22px; height: 22px; font-size: 12px; font-weight: bold; line-height: 20px;
             text-align: center; cursor: pointer; padding: 0; box-shadow: 1px 1px 3px rgba(0,0,0,0.5); z-index: 10;
         }
         .remove-button:hover { background-color: #a00; color: white; }

        /* Health Monitor Area */
        .health-monitor {
            background-color: var(--monitor-bg); border: 1px solid var(--text-color); border-radius: 2px;
            width: 100%; height: 160px; overflow: hidden; position: relative; margin-bottom: 10px;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 12px 12px; cursor: crosshair;
        }
        .svg-container { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 22px); z-index: 1; pointer-events: none; }
        .health-monitor svg { display: block; width: 100%; height: 100%; }
        .health-monitor path { stroke-dasharray: 3000; } /* Base dasharray */
        /* Corrected inline dasharray values will be used by SVG elements */

        /* HP Gradient Bar Styles */
        .hp-gradient-bar { position: absolute; bottom: 5px; left: 5px; right: 5px; height: 12px; border-radius: 2px; background: linear-gradient(to right, var(--broken-color) 0%, var(--critical-color) 33%, var(--warning-color) 66%, var(--primary-color) 100%); z-index: 0; box-shadow: inset 0 0 3px 1px rgba(0,0,0,0.7); pointer-events: none; }
        .hp-gradient-mask { position: absolute; bottom: 5px; right: 5px; height: 12px; background-color: var(--monitor-bg); width: 0%; z-index: 0; transition: width 0.3s ease-out; border-radius: 0 2px 2px 0; pointer-events: none; }

        /* Overlay Text Container (Name, Status) */
        .monitor-text-overlay { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 22px); padding: 5px 8px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: space-between; z-index: 2; pointer-events: none; }
        .monitor-text-overlay > * { pointer-events: auto; } .monitor-text-overlay > div { pointer-events: none; } .monitor-text-overlay > div > * { pointer-events: auto; }

        /* Name Display & Edit Input Styles */
        .char-name-display { display: inline-block; background-color: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 2px; font-size: 1.6em; color: var(--overlay-text-color); text-shadow: var(--text-shadow); text-transform: uppercase; cursor: pointer; max-width: calc(100% - 30px); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .char-name-edit { display: none; background-color: var(--input-bg); border: 1px solid var(--warning-color); color: var(--overlay-text-color); font-family: inherit; font-size: 1.6em; text-transform: uppercase; padding: 1px 5px; width: calc(100% - 30px); box-sizing: border-box; outline: none; }
        /* Status Text Overlay Style */
        .status-overlay { align-self: flex-end; background-color: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 2px; font-size: 1.1em; font-weight: bold; color: var(--overlay-text-color); text-shadow: var(--text-shadow); text-transform: uppercase; }

        /* Sections Below Monitor */
        .hp-controls, .info-grid, .condition-action-panel {
            padding: 8px 5px; margin-top: 8px; border-top: 1px solid rgba(var(--primary-color), 0.3);
        }
        .hp-controls { margin-top: 0; border-top: none; padding-top: 0;}

        /* HP Controls Area */
        .hp-controls { display: flex; flex-direction: column; gap: 8px; align-items: center; padding-bottom: 10px; }
        .hp-adjust { display: flex; justify-content: center; align-items: center; width: 100%; }
        .hp-adjust button { width: 45px; height: 35px; padding: 0; font-size: 1.5em; line-height: 1; margin: 0 10px; cursor: pointer; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 2px; }
        .hp-inputs-wrapper { display: flex; justify-content: space-around; width: 100%; margin-top: 5px;}
        .hp-input-group { display: flex; flex-direction: column; align-items: center; font-size: 0.9em;}
        .hp-input-group label { margin-bottom: 2px;}
        .hp-input-group input { width: 60px; text-align: right; padding: 2px 4px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 2px; font-family: inherit; font-size: 1em; -moz-appearance: textfield; }
        .hp-input-group input::-webkit-inner-spin-button, .hp-input-group input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        /* Info Grid (Type, Init, Stress, Rad) */
        .info-grid { display: flex; flex-direction: column; gap: 8px; }
        .stat-adjust { display: flex; justify-content: space-between; align-items: center; }
        .info-grid label { font-weight: normal; margin-right: 5px; color: var(--text-color); flex-shrink: 0; }
        .value-adjust-wrapper { display: flex; align-items: center; gap: 5px; }
        .value-adjust-wrapper button { width: 25px; height: 25px; padding: 0; font-size: 1.1em; line-height: 1; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 2px; cursor: pointer; }
        .value-adjust-wrapper button:hover:not(:disabled) { background-color: var(--primary-color); color: black; border-color: black; }
        .value-adjust-wrapper button:active:not(:disabled) { transform: translateY(1px); }
        .value-adjust-wrapper input[type="number"] { width: 50px; text-align: right; padding: 2px 4px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 2px; font-family: inherit; font-size: 1em; -moz-appearance: textfield; }
        .value-adjust-wrapper input[type=number]::-webkit-inner-spin-button, .value-adjust-wrapper input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input:disabled { background-color: #333; opacity: 0.6; cursor: not-allowed; border-color: #444; }
        button:disabled { opacity: 0.5; cursor: not-allowed; } /* Style disabled buttons */

        /* Style for Type Selector */
        .type-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 2px; font-family: inherit; font-size: 1em; padding: 2px 4px; flex-grow: 1; max-width: 150px; }
        .type-select:focus { outline: none; border-color: var(--warning-color); }

        /* Condition/Action Panel */
        .condition-action-panel { display: flex; gap: 10px; align-items: flex-start; }
        /* Actions Stack (Left) */
        .actions-stack { display: flex; flex-direction: column; gap: 8px; flex-basis: 120px; flex-shrink: 0; }
        .actions-stack button { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); font-family: inherit; font-size: 0.9em; padding: 4px 8px; border-radius: 2px; cursor: pointer; text-transform: uppercase; width: 100%; text-align: center; }
        .actions-stack button:hover:not(:disabled) { background-color: var(--primary-color); color: black; border-color: black; }
        .actions-stack button:active:not(:disabled) { transform: translateY(1px); }
        .mark-incapacitated-btn.condition-active { border-color: var(--incapacitated-color); color: var(--incapacitated-color); background-color: #002b4d; font-weight: bold; }

        /* Condition Grid (Right) */
        .condition-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; flex-grow: 1; }
        .condition-toggle { padding: 3px 5px; font-size: 0.85em; opacity: 0.7; border-width: 1px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--input-border); font-family: inherit; border-radius: 2px; cursor: pointer; text-transform: uppercase; text-align: center; flex-basis: calc(50% - 3px); box-sizing: border-box; }
        .condition-toggle.condition-active { border-color: var(--warning-color); color: var(--warning-color); background-color: #440; opacity: 1.0; font-weight: bold; }

        /* --- Status-Specific Styling --- */
        .character-card.status-dead { border-color: var(--dead-color); box-shadow: inset 0 0 8px 0px rgba(100,100,100, 0.5), 3px 3px 8px rgba(0, 0, 0, 0.7); opacity: 0.7; }
        .character-card.status-dead .monitor-text-overlay, .character-card.status-dead .hp-controls, .character-card.status-dead .info-grid, .character-card.status-dead .condition-action-panel, .character-card.status-dead .health-monitor { filter: grayscale(90%); }
        .character-card.status-dead .monitor-text-overlay *, .character-card.status-dead .hp-controls *, .character-card.status-dead .info-grid *, .character-card.status-dead .actions-stack button, .character-card.status-dead .condition-toggle { color: var(--dead-color) !important; border-color: var(--dead-color) !important; text-shadow: 1px 1px 2px black; }
        .character-card.status-dead input, .character-card.status-dead button { pointer-events: none !important; }
        .character-card.status-dead .remove-button { pointer-events: auto !important; filter: none; opacity: 1; }
        .character-card.status-dead .char-name-display { cursor: default; }

        .character-card.status-incapacitated { border-color: var(--incapacitated-color); }
        .character-card.status-broken { border-color: var(--broken-color); }
        .character-card.status-critical { border-color: var(--critical-color); }
        .character-card.status-injured { border-color: var(--warning-color); }
    </style>
</head>
<body>

<div class="dashboard-container">
    <h1>COMBAT OPERATIONS DASHBOARD</h1>
    <div class="main-controls">
        <button onclick="addCombatant()">Add Combatant</button>
    </div>
    <div class="dashboard" id="dashboard">
        </div>
</div>

<script>
    // --- SVG Data Store ---
    // UPDATED: Corrected animation direction for healthy, injured, critical
    const svgStates = {
        healthy: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="black"/>
             <path d="M17.902,114.475h26.949c2.296,0,12.876-10.182,20.063-10.182 c7.186,0,10.83,10.182,12.576,10.182h18.266l7.187,10.779l7.485-100.91l5.091,114.984l6.887-24.554h24.41 c3.239,0,14.816-16.769,20.206-16.769s11.08,16.47,13.475,16.47c2.845,0,26.665,0,26.665,0l27.757,0 c2.296,0,12.875-10.181,20.062-10.181c7.186,0,10.831,10.181,12.577,10.181h18.266l7.187,10.779l7.485-100.91l5.091,114.984 l6.888-24.555h24.41c3.24,0,14.817-16.768,20.207-16.768s11.079,16.469,13.474,16.469c2.845,0,26.666,0,26.666,0h27.813 c2.297,0,12.877-10.181,20.063-10.181s10.829,10.181,12.576,10.181h18.265l7.188,10.779l7.485-100.91l5.092,114.984l6.887-24.555 h24.409c3.238,0,14.816-16.768,20.206-16.768s11.08,16.469,13.476,16.469c2.845,0,26.664,0,26.664,0h27.815 c2.296,0,12.875-10.181,20.063-10.181c7.187,0,10.829,10.181,12.576,10.181h18.265l7.188,10.779l7.486-100.91l5.091,114.984 l6.887-24.555h24.409c3.238,0,14.816-16.768,20.206-16.768s11.079,16.469,13.476,16.469c2.846,0,26.664,0,26.664,0"
                   fill="none" stroke="lime" stroke-width="2" stroke-dasharray="3000">
                   <animate attributeName="stroke-dashoffset" from="3000" to="0" dur="5s" linear="true" repeatCount="indefinite"/>
             </path>
         </svg>`,
        injured: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="black"/>
             <path d="M 0,114.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5 h 8.7 c 1.3,0 2.5,-1.1 4.4,-1.7 0.8,-0.2 2.8,1.9 3.5,1.7 0.7,-0.2 1.1,-1.9 1.9,-1.5 2.3,1.1 2,-0.1 2.3,-0.1 0.3,0 1.6,0.6 2.3,0.8 0.7,0.2 0.7,0.1 1.5,0.3 0.8,0.2 3,-1.2 4.1,-1.1 1.1,0.1 2.1,1.1 3.7,0.9 3.7,-0.5 4.3,1.5 4.3,1.5 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 1,-34.1 3.7,-34.4 0.7,-0.1 2.2,-1.4 2.9,-1.5 0.7,0 0.6,1.1 1.3,1 0.7,-0.1 2.4,0.9 3.1,0.8 0.7,-0.1 0.4,-1.2 1,-1.3 0.7,-0.1 2.1,-0.8 2.8,-0.8 0.6,-0.1 0.4,0.5 0.9,0.4 0.5,-0.1 0.6,0.9 1.1,0.9 0.4,0 1.3,-1.1 1.6,-1.1 0.3,0 7.3,-17.9 15,-17.4 7.7,0.6 7,17.7 16.7,17.7 1.2,0 3,-1.9 3.1,-0.01 0.1,1.5 2.4,-0.7 2.9,-0.03 0.8,1.2 2.5,0.2 3.1,0.2 0.6,0 0.4,0.2 0.5,-0.3 0.4,-1.2 0.8,0 1.1,0 0.3,0 0.5,0 0.7,-0.1 0.2,0 0.3,0 0.4,-0.1 c 0.1,0 0.1,-0.01 0.1,-0.01 h 17.5"
                  fill="none" stroke="#FFD700" stroke-width="2" stroke-dasharray="2000">
                 <animate attributeName="stroke-dashoffset" from="2000" to="0" dur="5s" linear="true" repeatCount="indefinite"/>
             </path>
         </svg>`,
        critical: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="black"/>
             <path d="M 0,114.5 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9 h 11.5 c 5.2,0 3.8,-7 8.1,-6.7 4.3,0.3 1.9,7.7 8.2,7 c 3.7,-0.5 5.2,0.9 5.2,0.9 l 2.6,4.8 3.9,-66 1.2,95.8 c 0,0 2.2,-28.6 3.9,-35 c 1.7,-6.4 3,-23.8 7.6,-30.8 c 4,-6.1 8.8,-10 12.3,-8.6 c 3.5,1.4 6.5,15.2 9.7,21 c 3.2,5.9 7,17.7 16.7,17.7 c 9.8,0 11.9,-0.3 11.9,-0.3 h 17.9"
                  fill="none" stroke="#FF851B" stroke-width="2" stroke-dasharray="2000">
                 <animate attributeName="stroke-dashoffset" from="2000" to="0" dur="5s" linear="true" repeatCount="indefinite"/>
             </path>
         </svg>`,
        broken: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="black"/> <path d="M0,100 H800" fill="none" stroke="#FF4136" stroke-width="4"><animate attributeName="stroke-dashoffset" from="800" to="0" dur="1.8s" linear="true" repeatCount="indefinite"/></path> </svg>`,
        dead: `<svg width="100%" height="100%" viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMinYMid slice"><rect width="100%" height="100%" fill="black"/> <path d="M0,100 H800" fill="none" stroke="#555555" stroke-width="4"></path> </svg>`,
    };

    // --- Character Data Store ---
    let characters = {
        char1: { name: "HUDSON", hpMax: 10, hpCurrent: 10, initiative: 8, stress: 0, radiation: 0, conditions: [], type: 'PC', status: "Healthy", svgStateKey: 'healthy' },
        npc1: { name: "APONE", hpMax: 12, hpCurrent: 12, initiative: 7, stress: 0, radiation: 0, conditions: [], type: 'NPC', status: "Healthy", svgStateKey: 'healthy' },
        xeno1: { name: "STALKER", hpMax: 15, hpCurrent: 15, initiative: 3, stress: null, radiation: null, conditions: [], type: 'Creature', status: "Healthy", svgStateKey: 'healthy' },
        char2: { name: "VASQUEZ", hpMax: 11, hpCurrent: 5, initiative: 5, stress: 2, radiation: 0, conditions: ["Exhausted"], type: 'PC', status: "Injured", svgStateKey: 'injured' },
    };
    let nextCombatantIdCounter = Object.keys(characters).length + 1;
    let isDraggingHpBar = false; let currentDragCharId = null;

    // --- Functions ---
    // (All JavaScript functions remain the same as the previous version)
    function generateNewCombatantId() { let newId; do { newId = `combatant${nextCombatantIdCounter++}`; } while (characters[newId]); return newId; }
    function addCombatant() { const newId = generateNewCombatantId(); characters[newId] = { name: "NEW MARINE", hpMax: 10, hpCurrent: 10, initiative: 10, stress: 0, radiation: 0, conditions: [], type: 'NPC', status: "Healthy", svgStateKey: 'healthy' }; renderDashboard(); }
    function removeCombatant(charId) { const c = characters[charId]; if (!c) return; if (confirm(`Remove ${c.name}?`)) { delete characters[charId]; renderDashboard(); } }
    function showNameInput(charId, inputId, displayId) { const i = document.getElementById(inputId); const d = document.getElementById(displayId); if (!i||!d) return; i.value = characters[charId].name; d.style.display = 'none'; i.style.display = 'inline-block'; i.focus(); i.select(); }
    function hideNameInput(charId, inputId, displayId, save) { const i = document.getElementById(inputId); const d = document.getElementById(displayId); if (!i||!d) return; i.style.display = 'none'; d.style.display = 'inline-block'; if (save && i.value.trim() !== characters[charId].name ) { updateStatus(charId, 'setName', i.value); } else { renderCharacterCard(charId); } }
    function setAnimationSpeed(monitorElement, charData) { const anim = monitorElement.querySelector('svg path animate'); if (anim) { let dur = '5s'; switch (charData.status.toLowerCase()) { case 'injured': dur = '4s'; break; case 'critical': dur = '2.8s'; break; case 'broken': case 'incapacitated': dur = '2.5s'; break; } if (anim.getAttribute('dur') !== dur) { anim.setAttribute('dur', dur); } } }
    function handleHpBarInteraction(event, charId, type) { const c = characters[charId]; const mon = event.currentTarget; if (!c || c.status === 'Dead' || event.button !== 0) { isDraggingHpBar = false; currentDragCharId = null; mon.style.cursor = 'crosshair'; return; } const r = mon.getBoundingClientRect(); const pad = 5; const h = 12; const bot = r.height - pad; const top = bot - h; if (event.clientY < r.top + top - pad || event.clientY > r.top + bot + pad ) { if (isDraggingHpBar && type !== 'drag') { isDraggingHpBar = false; currentDragCharId = null; mon.style.cursor = 'crosshair'; } return; } const x = event.clientX - r.left - pad; const w = mon.clientWidth - (pad * 2); let hpPct = Math.max(0, Math.min(100, (x / w) * 100)); let hp = Math.round((hpPct / 100) * c.hpMax); switch (type) { case 'start': isDraggingHpBar = true; currentDragCharId = charId; updateStatus(charId, 'setCurrentHp', hp); mon.style.cursor = 'grabbing'; event.preventDefault(); break; case 'drag': if (isDraggingHpBar && currentDragCharId === charId) { updateStatus(charId, 'setCurrentHp', hp); } break; case 'stop': if (isDraggingHpBar && currentDragCharId === charId) { isDraggingHpBar = false; currentDragCharId = null; mon.style.cursor = 'crosshair'; } break; } }

    function renderCharacterCard(charId) {
        const character = characters[charId]; const card = document.getElementById(charId); if (!character || !card) return;
        const statuses = ['healthy', 'injured', 'critical', 'broken', 'incapacitated', 'dead']; statuses.forEach(s => card.classList.remove(`status-${s}`)); if (character.status) { card.classList.add(`status-${character.status.toLowerCase()}`); }
        const nameDisplay = card.querySelector('.char-name-display'); const nameInput = card.querySelector('.char-name-edit'); if (nameDisplay && nameInput && document.activeElement !== nameInput) { nameDisplay.textContent = character.name.toUpperCase(); nameInput.value = character.name; nameDisplay.style.display = 'inline-block'; nameInput.style.display = 'none'; } else if (nameDisplay && nameInput && document.activeElement === nameInput) { nameDisplay.style.display = 'none'; }
        const statusOverlay = card.querySelector('.status-overlay'); if(statusOverlay) statusOverlay.textContent = character.status.toUpperCase();
        const maxHpInput = card.querySelector('.input-hp-max'); if (maxHpInput && document.activeElement !== maxHpInput) maxHpInput.value = character.hpMax;
        const currentHpInput = card.querySelector('.input-hp-current'); if (currentHpInput && document.activeElement !== currentHpInput) currentHpInput.value = character.hpCurrent;
        const initiativeInput = card.querySelector('.input-initiative'); if (initiativeInput && document.activeElement !== initiativeInput) initiativeInput.value = character.initiative;
        const stressInput = card.querySelector('.input-stress'); const radiationInput = card.querySelector('.input-radiation'); const typeSelect = card.querySelector('.type-select');
        if (typeSelect && document.activeElement !== typeSelect) { typeSelect.value = character.type; }
        const canHaveStressRad = (character.type === 'PC' || character.type === 'NPC'); const stressElements = [stressInput, card.querySelector(`#inc-stress-${charId}`), card.querySelector(`#dec-stress-${charId}`)]; const radElements = [radiationInput, card.querySelector(`#inc-rad-${charId}`), card.querySelector(`#dec-rad-${charId}`)]; stressElements.forEach(el => { if(el) el.disabled = !canHaveStressRad; }); radElements.forEach(el => { if(el) el.disabled = !canHaveStressRad; });
        if (stressInput && document.activeElement !== stressInput) stressInput.value = canHaveStressRad ? character.stress : '';
        if (radiationInput && document.activeElement !== radiationInput) radiationInput.value = canHaveStressRad ? character.radiation : '';
        const hpPercent = character.hpMax > 0 ? (character.hpCurrent / character.hpMax) * 100 : 0; const maskElement = card.querySelector('.hp-gradient-mask'); if (maskElement) { maskElement.style.width = `${100 - hpPercent}%`; }
        const monitor = card.querySelector('.health-monitor'); const svgContainer = card.querySelector('.svg-container'); const svgKey = character.svgStateKey;
        if (monitor && svgContainer && monitor.dataset.currentSvgKey !== svgKey) { requestAnimationFrame(() => { if(document.getElementById(charId)) { svgContainer.innerHTML = svgStates[svgKey] || svgStates['healthy']; monitor.dataset.currentSvgKey = svgKey; setAnimationSpeed(monitor, character); } }); } else if (monitor) { setAnimationSpeed(monitor, character); }
        const conditions = ["Starving", "Dehydrated", "Exhausted", "Freezing", "Incapacitated"]; conditions.forEach(cond => { const btnIdSuffix = cond.toLowerCase().replace(/\s+/g, '-'); const btn = card.querySelector(`#cond-${btnIdSuffix}-${charId}`); if (btn) { if (character.conditions?.includes(cond)) { btn.classList.add('condition-active'); } else { btn.classList.remove('condition-active'); } } });
        const incapBtn = card.querySelector('.mark-incapacitated-btn'); if(incapBtn){ if(character.conditions?.includes('Incapacitated')){ incapBtn.classList.add('condition-active'); } else { incapBtn.classList.remove('condition-active'); } }
    }

     function createCharacterCardElement(charId) {
         const character = characters[charId]; if (!character) return null;
         const card = document.createElement('div'); card.className = 'character-card'; card.id = charId;
         if (character.status) { card.classList.add(`status-${character.status.toLowerCase()}`); }
         const nameDisplayId = `name-display-${charId}`; const nameInputId = `name-edit-${charId}`; const typeSelectId = `type-${charId}`;

         card.innerHTML = `
            <button class="remove-button" onclick="removeCombatant('${charId}')" title="Remove ${character.name}">X</button>
            <div class="health-monitor" data-current-svg-key="" onmousedown="handleHpBarInteraction(event, '${charId}', 'start')" onmousemove="handleHpBarInteraction(event, '${charId}', 'drag')" onmouseup="handleHpBarInteraction(event, '${charId}', 'stop')" onmouseleave="handleHpBarInteraction(event, '${charId}', 'stop')">
                <div class="hp-gradient-bar"></div> <div class="hp-gradient-mask"></div> <div class="svg-container"></div>
                <div class="monitor-text-overlay">
                    <div><span class="char-name-display" id="${nameDisplayId}" onclick="showNameInput('${charId}', '${nameInputId}', '${nameDisplayId}')" title="Click to edit name">${character.name.toUpperCase()}</span><input type="text" class="char-name-edit" id="${nameInputId}" value="${character.name}" onblur="hideNameInput('${charId}', '${nameInputId}', '${nameDisplayId}', true)" onkeydown="if(event.key === 'Enter') { this.blur(); } else if (event.key === 'Escape') { hideNameInput('${charId}', '${nameInputId}', '${nameDisplayId}', false); this.blur(); }" placeholder="ENTER NAME" style="display: none;"></div>
                    <span class="status-overlay">${character.status.toUpperCase()}</span>
                </div>
            </div>
            <div class="hp-controls"> <div class="hp-adjust"> <span> <button onclick="updateStatus('${charId}', 'decrementHp', 1)" title="Decrease HP by 1">-</button> <label> ADJUST HP </label> <button onclick="updateStatus('${charId}', 'incrementHp', 1)" title="Increase HP by 1">+</button> </span> </div> <div class="hp-inputs-wrapper"> <div class="hp-input-group"><label for="max-hp-${charId}">MAX:</label> <input type="number" id="max-hp-${charId}" class="input-hp-max" value="${character.hpMax}" min="1" onchange="updateStatus('${charId}', 'setMaxHp', this.value)"></div> <div class="hp-input-group"><label for="current-hp-${charId}">CURRENT:</label> <input type="number" id="current-hp-${charId}" class="input-hp-current" value="${character.hpCurrent}" min="0" onchange="updateStatus('${charId}', 'setCurrentHp', this.value)"></div> </div> </div>
            <div class="info-grid"> <div class="stat-adjust"> <label for="${typeSelectId}">TYPE:</label> <select id="${typeSelectId}" class="type-select" onchange="updateStatus('${charId}', 'setType', this.value)"> <option value="PC" ${character.type === 'PC' ? 'selected' : ''}>PC</option> <option value="NPC" ${character.type === 'NPC' ? 'selected' : ''}>NPC</option> <option value="Creature" ${character.type === 'Creature' ? 'selected' : ''}>Creature</option> </select> </div> <div class="stat-adjust"> <label for="init-${charId}">INIT:</label> <div class="value-adjust-wrapper"> <button onclick="updateStatus('${charId}', 'decrementInitiative', 1)" title="Decrease Initiative">-</button> <input type="number" id="init-${charId}" class="input-initiative" value="${character.initiative}" min="1" max="10" onchange="updateStatus('${charId}', 'setInitiative', this.value)"> <button onclick="updateStatus('${charId}', 'incrementInitiative', 1)" title="Increase Initiative">+</button> </div> </div> <div class="stat-adjust"> <label for="stress-${charId}">STRESS:</label> <div class="value-adjust-wrapper"> <button id="dec-stress-${charId}" onclick="updateStatus('${charId}', 'decrementStress', 1)">-</button> <input type="number" id="stress-${charId}" class="input-stress" value="${character.stress ?? ''}" min="0" max="10" onchange="updateStatus('${charId}', 'setStress', this.value)"> <button id="inc-stress-${charId}" onclick="updateStatus('${charId}', 'incrementStress', 1)">+</button> </div> </div> <div class="stat-adjust"> <label for="rad-${charId}">RAD:</label> <div class="value-adjust-wrapper"> <button id="dec-rad-${charId}" onclick="updateStatus('${charId}', 'decrementRadiation', 1)">-</button> <input type="number" id="rad-${charId}" class="input-radiation" value="${character.radiation ?? ''}" min="0" max="10" onchange="updateStatus('${charId}', 'setRadiation', this.value)"> <button id="inc-rad-${charId}" onclick="updateStatus('${charId}', 'incrementRadiation', 1)">+</button> </div> </div> </div>
            <div class="condition-action-panel"> <div class="actions-stack"> <button class="mark-incapacitated-btn" id="cond-incapacitated-${charId}" onclick="updateStatus('${charId}', 'toggleCondition', 'Incapacitated')" title="Toggle Incapacitated Status">Incapacitated</button> <button class="mark-dead-btn" onclick="updateStatus('${charId}', 'setDead', true)" title="Mark character as Dead">Mark Dead</button> </div> <div class="condition-grid"> <button class="condition-toggle" id="cond-starving-${charId}" onclick="updateStatus('${charId}', 'toggleCondition', 'Starving')">Starving</button> <button class="condition-toggle" id="cond-dehydrated-${charId}" onclick="updateStatus('${charId}', 'toggleCondition', 'Dehydrated')">Dehydrated</button> <button class="condition-toggle" id="cond-exhausted-${charId}" onclick="updateStatus('${charId}', 'toggleCondition', 'Exhausted')">Exhausted</button> <button class="condition-toggle" id="cond-freezing-${charId}" onclick="updateStatus('${charId}', 'toggleCondition', 'Freezing')">Freezing</button> </div> </div>
        `;
         return card;
     }

    function renderDashboard() { const dashboardElement = document.getElementById('dashboard'); if (!dashboardElement) { console.error("Dashboard element not found!"); return; } const activeElement = document.activeElement; const activeElementId = activeElement ? activeElement.id : null; const activeElementValue = activeElement ? activeElement.value : null; const activeElementSelectionStart = activeElement ? activeElement.selectionStart : null; const activeElementSelectionEnd = activeElement ? activeElement.selectionEnd : null; dashboardElement.innerHTML = ''; const sortedCharIds = Object.keys(characters).sort((a, b) => { const initA = Number(characters[a]?.initiative) || 99; const initB = Number(characters[b]?.initiative) || 99; return initA - initB; }); sortedCharIds.forEach(charId => { const cardElement = createCharacterCardElement(charId); if (cardElement) { dashboardElement.appendChild(cardElement); renderCharacterCard(charId); } }); if (activeElementId) { const el = document.getElementById(activeElementId); if (el) { el.focus(); if (el.tagName === 'INPUT' && activeElementValue !== null && typeof el.value !== 'undefined') { /* Value restore */ } if (activeElementSelectionStart !== null && typeof el.setSelectionRange === 'function') { try { el.setSelectionRange(activeElementSelectionStart, activeElementSelectionEnd); } catch (e) { console.warn("Could not restore selection range.", e); } } } } }

    function updateStatus(charId, action, value) { const character = characters[charId]; if (!character) return; const allowedIfDead = ['setInitiative', 'setMaxHp', 'setName']; if (character.status === 'Dead' && !allowedIfDead.includes(action)) { console.log(`${character.name} is Dead. Changes limited.`); return; } let needsDashboardSort = false; const previousStatus = character.status; let statusChangedByCondition = false; switch (action) { case 'setName': if(typeof value === 'string') { character.name = value.trim() || "Unnamed"; } break; case 'setType': const validTypes = ['PC', 'NPC', 'Creature']; if (validTypes.includes(value)) { character.type = value; if (value === 'Creature') { character.stress = null; character.radiation = null; } else { if (character.stress === null) character.stress = 0; if (character.radiation === null) character.radiation = 0; } } break; case 'setMaxHp': const newMaxHp = parseInt(value, 10); if (!isNaN(newMaxHp) && newMaxHp >= 1) { character.hpMax = newMaxHp; character.hpCurrent = Math.min(character.hpCurrent, character.hpMax); } else { console.warn(`Invalid Max HP: ${value}`); const iEl = document.getElementById(`max-hp-${charId}`); if(iEl) iEl.value = character.hpMax; } break; case 'setCurrentHp': const newCurrentHp = parseInt(value, 10); if (!isNaN(newCurrentHp)) { if (character.status === 'Dead') break; character.hpCurrent = Math.max(0, Math.min(newCurrentHp, character.hpMax)); } else { console.warn(`Invalid Current HP: ${value}`); const iEl = document.getElementById(`current-hp-${charId}`); if(iEl) iEl.value = character.hpCurrent; } break; case 'incrementHp': if (character.status === 'Dead' || character.status === 'Broken' || character.status === 'Incapacitated' ) break; character.hpCurrent = Math.min(character.hpMax, character.hpCurrent + 1); break; case 'decrementHp': if (character.status === 'Dead') break; character.hpCurrent = Math.max(0, character.hpCurrent - 1); break; case 'setInitiative': const newInitiative = parseInt(value, 10); if (!isNaN(newInitiative) && newInitiative >= 1 && newInitiative <= 10) { if(character.initiative !== newInitiative) { character.initiative = newInitiative; needsDashboardSort = true; } } else { console.warn(`Invalid Initiative: ${value}`); const iEl = document.getElementById(`init-${charId}`); if(iEl) iEl.value = character.initiative; } break; case 'incrementInitiative': character.initiative = Math.min(10, (Number(character.initiative) || 0) + 1); needsDashboardSort = true; break; case 'decrementInitiative': character.initiative = Math.max(1, (Number(character.initiative) || 0) - 1); needsDashboardSort = true; break; case 'setStress': const newStress = parseInt(value, 10); if (character.type !== 'Creature' && character.stress !== null && !isNaN(newStress)) { character.stress = Math.max(0, Math.min(newStress, 10)); } else if (character.stress !== null) { console.warn(`Invalid Stress: ${value}`); const iEl = document.getElementById(`stress-${charId}`); if(iEl) iEl.value = character.stress; } break; case 'incrementStress': if(character.type !== 'Creature' && character.stress !== null) { character.stress = Math.min(10, character.stress + 1); } break; case 'decrementStress': if(character.type !== 'Creature' && character.stress !== null) { character.stress = Math.max(0, character.stress - 1); } break; case 'setRadiation': const newRad = parseInt(value, 10); if (character.type !== 'Creature' && character.radiation !== null && !isNaN(newRad)) { character.radiation = Math.max(0, Math.min(newRad, 10)); } else if (character.radiation !== null) { console.warn(`Invalid Radiation: ${value}`); const iEl = document.getElementById(`rad-${charId}`); if(iEl) iEl.value = character.radiation; } break; case 'incrementRadiation': if(character.type !== 'Creature' && character.radiation !== null) { character.radiation = Math.min(10, character.radiation + 1); } break; case 'decrementRadiation': if(character.type !== 'Creature' && character.radiation !== null) { character.radiation = Math.max(0, character.radiation - 1); } break; case 'toggleCondition': if (character.conditions) { const index = character.conditions.indexOf(value); if (index > -1) { character.conditions.splice(index, 1); if (value === 'Incapacitated') statusChangedByCondition = true; } else { character.conditions.push(value); if (value === 'Incapacitated') statusChangedByCondition = true; } } break; case 'setDead': if (character.status !== 'Dead') { character.status = 'Dead'; character.hpCurrent = 0; character.svgStateKey = 'dead'; character.conditions = ['Dead']; statusChangedByCondition = true; } break; } if (character.status !== 'Dead') { const hpPercentage = character.hpMax > 0 ? (character.hpCurrent / character.hpMax) * 100 : 0; let calculatedStatus = "Healthy"; let calculatedSvgKey = "healthy"; if (character.conditions?.includes('Incapacitated')) { calculatedStatus = 'Incapacitated'; calculatedSvgKey = 'broken'; } else if (character.hpCurrent <= 0) { calculatedStatus = 'Broken'; calculatedSvgKey = 'broken'; if (previousStatus !== 'Broken' && previousStatus !== 'Incapacitated') { console.log(`${character.name} is Broken!`); } } else if (hpPercentage <= 33) { calculatedStatus = 'Critical'; calculatedSvgKey = 'critical'; } else if (hpPercentage <= 66) { calculatedStatus = 'Injured'; calculatedSvgKey = 'injured'; } if(character.status !== calculatedStatus || statusChangedByCondition) { character.status = calculatedStatus; } if(character.svgStateKey !== calculatedSvgKey) { character.svgStateKey = calculatedSvgKey; } if ((previousStatus === 'Broken' || previousStatus === 'Incapacitated') && character.hpCurrent > 0 && !character.conditions?.includes('Incapacitated')) { console.log(`${character.name} is no longer Broken/Incapacitated.`); } } else { character.svgStateKey = 'dead'; if (character.hpCurrent !== 0) character.hpCurrent = 0; if (character.conditions.length > 1 || !character.conditions.includes('Dead')) { character.conditions = ['Dead']; } } if (needsDashboardSort) { renderDashboard(); } else { renderCharacterCard(charId); } }

    // --- Initial Render ---
    document.addEventListener('DOMContentLoaded', renderDashboard);

</script>

</body>
</html>
